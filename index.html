<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>WebRTC File Sharing</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { padding: 10px; margin: 10px 0; width: 100%; }
    #progress { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>

<h2>Peer-to-Peer File Sharing</h2>

<input id="roomInput" placeholder="Enter Room ID (example: 1234)" />
<button id="createBtn">Create Room</button>
<button id="joinBtn">Join Room</button>

<br><br>

<input type="file" id="fileInput" />
<button id="sendBtn" disabled>Send File</button>

<p id="progress"></p>

<script type="module">
  // ------------------ YOUR FIREBASE CONFIG ------------------
  const firebaseConfig = {
    apiKey: "AIzaSyB0Ex5-_mLf8KNENaK0ugRk7ow1fORUq2k",
    authDomain: "sending-file-90a27.firebaseapp.com",
    databaseURL: "https://sending-file-90a27-default-rtdb.firebaseio.com",
    projectId: "sending-file-90a27",
    storageBucket: "sending-file-90a27.firebasestorage.app",
    messagingSenderId: "319899445088",
    appId: "1:319899445088:web:d33f39000428c54d212005",
    measurementId: "G-512FV333QR"
  };

  // ------------------ FIREBASE IMPORTS ------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc, collection, addDoc, onSnapshot } 
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ------------------ WEBRTC SETUP ------------------
  let pc = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  let dataChannel;
  let roomId;
  const createBtn = document.getElementById("createBtn");
  const joinBtn = document.getElementById("joinBtn");
  const sendBtn = document.getElementById("sendBtn");
  const fileInput = document.getElementById("fileInput");
  const progress = document.getElementById("progress");

  // ---------------------------------------
  // CREATE ROOM
  // ---------------------------------------
  createBtn.onclick = async () => {
    roomId = document.getElementById("roomInput").value.trim();
    if (!roomId) return alert("Enter room ID!");

    dataChannel = pc.createDataChannel("file");
    setupDataChannel();

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await setDoc(doc(db, "rooms", roomId), {
      offer: JSON.stringify(offer)
    });

    listenForAnswer();
    listenForCandidates();
  };

  // ---------------------------------------
  // JOIN ROOM
  // ---------------------------------------
  joinBtn.onclick = async () => {
    roomId = document.getElementById("roomInput").value.trim();
    if (!roomId) return alert("Enter room ID!");

    const roomRef = doc(db, "rooms", roomId);
    const roomSnap = await getDoc(roomRef);

    if (!roomSnap.exists()) return alert("Room not found!");

    const data = roomSnap.data();
    const offer = JSON.parse(data.offer);

    pc.ondatachannel = (e) => {
      dataChannel = e.channel;
      setupDataChannel();
    };

    await pc.setRemoteDescription(offer);

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);

    await setDoc(roomRef, {
      answer: JSON.stringify(answer)
    }, { merge: true });

    listenForCandidates();
  };

  // ---------------------------------------
  // ICE Candidates Exchange
  // ---------------------------------------
  pc.onicecandidate = async (event) => {
    if (event.candidate) {
      await addDoc(collection(db, "rooms", roomId, "candidates"), {
        candidate: JSON.stringify(event.candidate)
      });
    }
  };

  function listenForCandidates() {
    const candidatesRef = collection(db, "rooms", roomId, "candidates");

    onSnapshot(candidatesRef, (snap) => {
      snap.docChanges().forEach(async (change) => {
        if (change.type === "added") {
          let data = change.doc.data();
          let candidate = new RTCIceCandidate(JSON.parse(data.candidate));
          await pc.addIceCandidate(candidate);
        }
      });
    });
  }

  function listenForAnswer() {
    onSnapshot(doc(db, "rooms", roomId), async (snap) => {
      const data = snap.data();
      if (data.answer && !pc.currentRemoteDescription) {
        await pc.setRemoteDescription(JSON.parse(data.answer));
      }
    });
  }

  // ---------------------------------------
  // DATA CHANNEL FUNCTIONS
  // ---------------------------------------
  function setupDataChannel() {
    dataChannel.onopen = () => {
      sendBtn.disabled = false;
      progress.innerText = "Connected ✔ You can send file now.";
    };

    dataChannel.onmessage = (event) => {
      const blob = new Blob([event.data]);
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "received_file";
      a.click();
      progress.innerText = "File Received ✔";
    };
  }

  // ---------------------------------------
  // SEND FILE BUTTON
  // ---------------------------------------
  sendBtn.onclick = () => {
    const file = fileInput.files[0];
    if (!file) return alert("Select a file first!");

    progress.innerText = "Sending...";

    const reader = new FileReader();
    reader.onload = () => {
      dataChannel.send(reader.result);
      progress.innerText = "File Sent ✔";
    };
    reader.readAsArrayBuffer(file);
  };
</script>
</body>
</html>
